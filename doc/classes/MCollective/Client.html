<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: MCollective::Client</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">MCollective::Client</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/mcollective/client_rb.html">
                lib/mcollective/client.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Helpers for writing clients that can talk to agents, do discovery and so
forth
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000244">collective</a>&nbsp;&nbsp;
      <a href="#M000245">disconnect</a>&nbsp;&nbsp;
      <a href="#M000250">discover</a>&nbsp;&nbsp;
      <a href="#M000252">discovered_req</a>&nbsp;&nbsp;
      <a href="#M000253">display_stats</a>&nbsp;&nbsp;
      <a href="#M000243">new</a>&nbsp;&nbsp;
      <a href="#M000249">receive</a>&nbsp;&nbsp;
      <a href="#M000251">req</a>&nbsp;&nbsp;
      <a href="#M000246">sendreq</a>&nbsp;&nbsp;
      <a href="#M000247">subscribe</a>&nbsp;&nbsp;
      <a href="#M000248">unsubscribe</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">options</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">stats</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000243" class="method-detail">
        <a name="M000243"></a>

        <div class="method-heading">
          <a href="#M000243" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(configfile)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000243-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000243-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 6</span>
 6:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">configfile</span>)
 7:       <span class="ruby-ivar">@config</span> = <span class="ruby-constant">Config</span>.<span class="ruby-identifier">instance</span>
 8:       <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">loadconfig</span>(<span class="ruby-identifier">configfile</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">configured</span>
 9: 
10:       <span class="ruby-ivar">@connection</span> = <span class="ruby-constant">PluginManager</span>[<span class="ruby-value str">&quot;connector_plugin&quot;</span>]
11:       <span class="ruby-ivar">@security</span> = <span class="ruby-constant">PluginManager</span>[<span class="ruby-value str">&quot;security_plugin&quot;</span>]
12: 
13:       <span class="ruby-ivar">@security</span>.<span class="ruby-identifier">initiated_by</span> = <span class="ruby-identifier">:client</span>
14:       <span class="ruby-ivar">@options</span> = <span class="ruby-keyword kw">nil</span>
15:       <span class="ruby-ivar">@subscriptions</span> = {}
16: 
17:       <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">connect</span>
18:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000244" class="method-detail">
        <a name="M000244"></a>

        <div class="method-heading">
          <a href="#M000244" class="method-signature">
          <span class="method-name">collective</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the configured main <a href="Client.html#M000244">collective</a> if
no specific <a href="Client.html#M000244">collective</a> is specified as
options
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000244-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000244-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 22</span>
22:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">collective</span>
23:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:collective</span>].<span class="ruby-identifier">nil?</span>
24:         <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">main_collective</span>
25:       <span class="ruby-keyword kw">else</span>
26:         <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:collective</span>]
27:       <span class="ruby-keyword kw">end</span>
28:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000245" class="method-detail">
        <a name="M000245"></a>

        <div class="method-heading">
          <a href="#M000245" class="method-signature">
          <span class="method-name">disconnect</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Disconnects cleanly from the middleware
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000245-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000245-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 31</span>
31:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">disconnect</span>
32:       <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Disconnecting from the middleware&quot;</span>)
33:       <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
34:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000250" class="method-detail">
        <a name="M000250"></a>

        <div class="method-heading">
          <a href="#M000250" class="method-signature">
          <span class="method-name">discover</span><span class="method-args">(filter, timeout, limit=0)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Performs a discovery of nodes matching the filter passed returns an array
of nodes
</p>
<p>
An integer limit can be supplied this will have the effect of the discovery
being cancelled soon as it reached the requested limit of hosts
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000250-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000250-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 114</span>
114:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">discover</span>(<span class="ruby-identifier">filter</span>, <span class="ruby-identifier">timeout</span>, <span class="ruby-identifier">limit</span>=<span class="ruby-value">0</span>)
115:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Limit has to be an integer&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">limit</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fixnum</span>)
116: 
117:       <span class="ruby-keyword kw">begin</span>
118:         <span class="ruby-identifier">hosts</span> = []
119:         <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-identifier">timeout</span>) <span class="ruby-keyword kw">do</span>
120:           <span class="ruby-identifier">reqid</span> = <span class="ruby-identifier">sendreq</span>(<span class="ruby-value str">&quot;ping&quot;</span>, <span class="ruby-value str">&quot;discovery&quot;</span>, <span class="ruby-identifier">filter</span>)
121:           <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Waiting #{timeout} seconds for discovery replies to request #{reqid}&quot;</span>)
122: 
123:           <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
124:             <span class="ruby-identifier">reply</span> = <span class="ruby-identifier">receive</span>(<span class="ruby-identifier">reqid</span>)
125:             <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Got discovery reply from #{reply.payload[:senderid]}&quot;</span>)
126:             <span class="ruby-identifier">hosts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>]
127: 
128:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hosts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">limit</span>
129:           <span class="ruby-keyword kw">end</span>
130:         <span class="ruby-keyword kw">end</span>
131:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
132:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
133:         <span class="ruby-identifier">raise</span>
134:       <span class="ruby-keyword kw">ensure</span>
135:         <span class="ruby-identifier">unsubscribe</span>(<span class="ruby-value str">&quot;discovery&quot;</span>, <span class="ruby-identifier">:reply</span>)
136:       <span class="ruby-keyword kw">end</span>
137: 
138:       <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">sort</span>
139:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000252" class="method-detail">
        <a name="M000252"></a>

        <div class="method-heading">
          <a href="#M000252" class="method-signature">
          <span class="method-name">discovered_req</span><span class="method-args">(body, agent, options=false) {|resp.payload| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Performs a discovery and then send a request, performs the passed block for
each response
</p>
<pre>
   times = discovered_req(&quot;status&quot;, &quot;mcollectived&quot;, options, client) {|resp|
      pp resp
   }
</pre>
<p>
It returns a hash of times and timeouts for discovery and total run is
taken from the options hash which in turn is generally built using <a
href="Optionparser.html">MCollective::Optionparser</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000252-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000252-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 201</span>
201:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">discovered_req</span>(<span class="ruby-identifier">body</span>, <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">options</span>=<span class="ruby-keyword kw">false</span>)
202:       <span class="ruby-identifier">stat</span> = {<span class="ruby-identifier">:starttime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">:discoverytime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">:blocktime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">:totaltime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
203: 
204:       <span class="ruby-identifier">options</span> = <span class="ruby-ivar">@options</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>
205: 
206:       <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
207: 
208:       <span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;Determining the amount of hosts matching filter for #{options[:disctimeout]} seconds .... &quot;</span>)
209: 
210:       <span class="ruby-keyword kw">begin</span>
211:         <span class="ruby-identifier">discovered_hosts</span> = <span class="ruby-identifier">discover</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:filter</span>], <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:disctimeout</span>])
212:         <span class="ruby-identifier">discovered</span> = <span class="ruby-identifier">discovered_hosts</span>.<span class="ruby-identifier">size</span>
213:         <span class="ruby-identifier">hosts_responded</span> = []
214:         <span class="ruby-identifier">hosts_not_responded</span> = <span class="ruby-identifier">discovered_hosts</span>
215: 
216:         <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:discoverytime</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:starttime</span>]
217: 
218:         <span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;#{discovered}\n\n&quot;</span>)
219:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span>
220:         <span class="ruby-identifier">puts</span>(<span class="ruby-value str">&quot;Discovery interrupted.&quot;</span>)
221:         <span class="ruby-identifier">exit!</span>
222:       <span class="ruby-keyword kw">end</span>
223: 
224:       <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No matching clients found&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">discovered</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
225: 
226:       <span class="ruby-keyword kw">begin</span>
227:         <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timeout</span>]) <span class="ruby-keyword kw">do</span>
228:           <span class="ruby-identifier">reqid</span> = <span class="ruby-identifier">sendreq</span>(<span class="ruby-identifier">body</span>, <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:filter</span>])
229: 
230:           (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">discovered</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
231:             <span class="ruby-identifier">resp</span> = <span class="ruby-identifier">receive</span>(<span class="ruby-identifier">reqid</span>)
232: 
233:             <span class="ruby-identifier">hosts_responded</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">resp</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>]
234:             <span class="ruby-identifier">hosts_not_responded</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">resp</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hosts_not_responded</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">resp</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>])
235: 
236:             <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">resp</span>.<span class="ruby-identifier">payload</span>)
237:           <span class="ruby-keyword kw">end</span>
238:         <span class="ruby-keyword kw">end</span>
239:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
240:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
241:       <span class="ruby-keyword kw">end</span>
242: 
243:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:totaltime</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:starttime</span>]
244:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:blocktime</span>] = <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:totaltime</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:discoverytime</span>]
245:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:responses</span>] = <span class="ruby-identifier">hosts_responded</span>.<span class="ruby-identifier">size</span>
246:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:responsesfrom</span>] = <span class="ruby-identifier">hosts_responded</span>
247:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:noresponsefrom</span>] = <span class="ruby-identifier">hosts_not_responded</span>
248:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:discovered</span>] = <span class="ruby-identifier">discovered</span>
249: 
250:       <span class="ruby-ivar">@stats</span> = <span class="ruby-identifier">stat</span>
251:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">stat</span>
252:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000253" class="method-detail">
        <a name="M000253"></a>

        <div class="method-heading">
          <a href="#M000253" class="method-signature">
          <span class="method-name">display_stats</span><span class="method-args">(stats, options=false, caption=&quot;stomp call summary&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Prints out the stats returns from <a href="Client.html#M000251">req</a> and
<a href="Client.html#M000252">discovered_req</a> in a nice way
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000253-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000253-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 255</span>
255:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">display_stats</span>(<span class="ruby-identifier">stats</span>, <span class="ruby-identifier">options</span>=<span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">caption</span>=<span class="ruby-value str">&quot;stomp call summary&quot;</span>)
256:       <span class="ruby-identifier">options</span> = <span class="ruby-ivar">@options</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>
257: 
258:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:verbose</span>]
259:         <span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;\n---- #{caption} ----&quot;</span>)
260: 
261:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:discovered</span>]
262:           <span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;           Nodes: #{stats[:discovered]} / #{stats[:responses]}&quot;</span>)
263:         <span class="ruby-keyword kw">else</span>
264:           <span class="ruby-identifier">puts</span>(<span class="ruby-node">&quot;           Nodes: #{stats[:responses]}&quot;</span>)
265:         <span class="ruby-keyword kw">end</span>
266: 
267:         <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;      Start Time: %s\n&quot;</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>(<span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:starttime</span>]))
268:         <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;  Discovery Time: %.2fms\n&quot;</span>, <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:discoverytime</span>] <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>)
269:         <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;      Agent Time: %.2fms\n&quot;</span>, <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:blocktime</span>] <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>)
270:         <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;      Total Time: %.2fms\n&quot;</span>, <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:totaltime</span>] <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>)
271: 
272:       <span class="ruby-keyword kw">else</span>
273:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:discovered</span>]
274:           <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;\nFinished processing %d / %d hosts in %.2f ms\n\n&quot;</span>, <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:responses</span>], <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:discovered</span>], <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:blocktime</span>] <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>)
275:         <span class="ruby-keyword kw">else</span>
276:           <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;\nFinished processing %d hosts in %.2f ms\n\n&quot;</span>, <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:responses</span>], <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:blocktime</span>] <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>)
277:         <span class="ruby-keyword kw">end</span>
278:       <span class="ruby-keyword kw">end</span>
279: 
280:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:noresponsefrom</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
281:         <span class="ruby-identifier">puts</span>(<span class="ruby-value str">&quot;\nNo response from:\n&quot;</span>)
282: 
283:         <span class="ruby-identifier">stats</span>[<span class="ruby-identifier">:noresponsefrom</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
284:           <span class="ruby-identifier">puts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">%</span> <span class="ruby-value">4</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
285:           <span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;%30s&quot;</span>, <span class="ruby-identifier">c</span>)
286:         <span class="ruby-keyword kw">end</span>
287: 
288:         <span class="ruby-identifier">puts</span>
289:       <span class="ruby-keyword kw">end</span>
290:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000249" class="method-detail">
        <a name="M000249"></a>

        <div class="method-heading">
          <a href="#M000249" class="method-signature">
          <span class="method-name">receive</span><span class="method-args">(requestid = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Blocking call that waits for ever for a message to arrive.
</p>
<p>
If you give it a requestid this means you&#8216;ve previously send a
request with that ID and now you just want replies that matches that id, in
that case the current connection will just ignore all messages not directed
at it and keep waiting for more till it finds a matching message.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000249-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000249-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 84</span>
 84:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive</span>(<span class="ruby-identifier">requestid</span> = <span class="ruby-keyword kw">nil</span>)
 85:       <span class="ruby-identifier">reply</span> = <span class="ruby-keyword kw">nil</span>
 86: 
 87:       <span class="ruby-keyword kw">begin</span>
 88:         <span class="ruby-identifier">reply</span> = <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">receive</span>
 89:         <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">type</span> = <span class="ruby-identifier">:reply</span>
 90:         <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">expected_msgid</span> = <span class="ruby-identifier">requestid</span>
 91: 
 92:         <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">decode!</span>
 93: 
 94:         <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>] = <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">reply</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-identifier">:senderid</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;MCOLLECTIVE_ANON&quot;</span>)
 95: 
 96:         <span class="ruby-identifier">raise</span>(<span class="ruby-constant">MsgDoesNotMatchRequestID</span>, <span class="ruby-node">&quot;Message reqid #{requestid} does not match our reqid #{reply.requestid}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">requestid</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">requestid</span>
 97:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SecurityValidationFailed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
 98:         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-value str">&quot;Ignoring a message that did not pass security validations&quot;</span>)
 99:         <span class="ruby-keyword kw">retry</span>
100:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">MsgDoesNotMatchRequestID</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
101:         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Ignoring a message for some other client&quot;</span>)
102:         <span class="ruby-keyword kw">retry</span>
103:       <span class="ruby-keyword kw">end</span>
104: 
105:       <span class="ruby-identifier">reply</span>
106:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000251" class="method-detail">
        <a name="M000251"></a>

        <div class="method-heading">
          <a href="#M000251" class="method-signature">
          <span class="method-name">req</span><span class="method-args">(body, agent=nil, options=false, waitfor=0) {|resp.payload| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Send a request, performs the passed block for each response
</p>
<p>
times = <a href="Client.html#M000251">req</a>(&quot;status&quot;,
&quot;mcollectived&quot;, options, client) {|resp|
</p>
<pre>
  pp resp
</pre>
<p>
}
</p>
<p>
It returns a hash of times and timeouts for discovery and total run is
taken from the options hash which in turn is generally built using <a
href="Optionparser.html">MCollective::Optionparser</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000251-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000251-source">
<pre>
     <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 149</span>
149:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">req</span>(<span class="ruby-identifier">body</span>, <span class="ruby-identifier">agent</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">options</span>=<span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">waitfor</span>=<span class="ruby-value">0</span>)
150:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Message</span>)
151:         <span class="ruby-identifier">agent</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">agent</span>
152:         <span class="ruby-identifier">options</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">options</span>
153:         <span class="ruby-identifier">waitfor</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">discovered_hosts</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
154:       <span class="ruby-keyword kw">end</span>
155: 
156:       <span class="ruby-identifier">stat</span> = {<span class="ruby-identifier">:starttime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">:discoverytime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">:blocktime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">:totaltime</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
157: 
158:       <span class="ruby-identifier">options</span> = <span class="ruby-ivar">@options</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>
159: 
160:       <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
161: 
162:       <span class="ruby-identifier">hosts_responded</span> = <span class="ruby-value">0</span>
163: 
164:       <span class="ruby-keyword kw">begin</span>
165:         <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timeout</span>]) <span class="ruby-keyword kw">do</span>
166:           <span class="ruby-identifier">reqid</span> = <span class="ruby-identifier">sendreq</span>(<span class="ruby-identifier">body</span>, <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:filter</span>])
167: 
168:           <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
169:             <span class="ruby-identifier">resp</span> = <span class="ruby-identifier">receive</span>(<span class="ruby-identifier">reqid</span>)
170: 
171:             <span class="ruby-identifier">hosts_responded</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
172: 
173:             <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">resp</span>.<span class="ruby-identifier">payload</span>)
174: 
175:             <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">waitfor</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">hosts_responded</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">waitfor</span>)
176:           <span class="ruby-keyword kw">end</span>
177:         <span class="ruby-keyword kw">end</span>
178:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
179:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
180:       <span class="ruby-keyword kw">ensure</span>
181:         <span class="ruby-identifier">unsubscribe</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">:reply</span>)
182:       <span class="ruby-keyword kw">end</span>
183: 
184:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:totaltime</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:starttime</span>]
185:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:blocktime</span>] = <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:totaltime</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:discoverytime</span>]
186:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:responses</span>] = <span class="ruby-identifier">hosts_responded</span>
187:       <span class="ruby-identifier">stat</span>[<span class="ruby-identifier">:noresponsefrom</span>] = []
188: 
189:       <span class="ruby-ivar">@stats</span> = <span class="ruby-identifier">stat</span>
190:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">stat</span>
191:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000246" class="method-detail">
        <a name="M000246"></a>

        <div class="method-heading">
          <a href="#M000246" class="method-signature">
          <span class="method-name">sendreq</span><span class="method-args">(msg, agent, filter = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sends a request and returns the generated request id, doesn&#8216;t wait
for responses and doesn&#8216;t execute any passed in code blocks for
responses
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000246-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000246-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 38</span>
38:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sendreq</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">filter</span> = {})
39:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Message</span>)
40:         <span class="ruby-identifier">request</span> = <span class="ruby-identifier">msg</span>
41:         <span class="ruby-identifier">agent</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">agent</span>
42:       <span class="ruby-keyword kw">else</span>
43:         <span class="ruby-identifier">ttl</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:ttl</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">ttl</span>
44:         <span class="ruby-identifier">request</span> = <span class="ruby-constant">Message</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-keyword kw">nil</span>, {<span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:collective</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">collective</span>, <span class="ruby-identifier">:filter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filter</span>, <span class="ruby-identifier">:ttl</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ttl</span>})
45:         <span class="ruby-identifier">request</span>.<span class="ruby-identifier">reply_to</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:reply_to</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:reply_to</span>]
46:       <span class="ruby-keyword kw">end</span>
47: 
48:       <span class="ruby-identifier">request</span>.<span class="ruby-identifier">encode!</span>
49: 
50:       <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Sending request #{request.requestid} to the #{request.agent} agent with ttl #{request.ttl} in collective #{request.collective}&quot;</span>)
51: 
52:       <span class="ruby-identifier">subscribe</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">:reply</span>)
53: 
54:       <span class="ruby-identifier">request</span>.<span class="ruby-identifier">publish</span>
55: 
56:       <span class="ruby-identifier">request</span>.<span class="ruby-identifier">requestid</span>
57:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000247" class="method-detail">
        <a name="M000247"></a>

        <div class="method-heading">
          <a href="#M000247" class="method-signature">
          <span class="method-name">subscribe</span><span class="method-args">(agent, type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000247-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000247-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 59</span>
59:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">subscribe</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">type</span>)
60:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@subscriptions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">agent</span>)
61:         <span class="ruby-identifier">subscription</span> = <span class="ruby-constant">Util</span>.<span class="ruby-identifier">make_subscriptions</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">collective</span>)
62:         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Subscribing to #{type} target for agent #{agent}&quot;</span>)
63: 
64:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">subscribe</span>(<span class="ruby-identifier">subscription</span>)
65:         <span class="ruby-ivar">@subscriptions</span>[<span class="ruby-identifier">agent</span>] = <span class="ruby-value">1</span>
66:       <span class="ruby-keyword kw">end</span>
67:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000248" class="method-detail">
        <a name="M000248"></a>

        <div class="method-heading">
          <a href="#M000248" class="method-signature">
          <span class="method-name">unsubscribe</span><span class="method-args">(agent, type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000248-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000248-source">
<pre>
    <span class="ruby-comment cmt"># File lib/mcollective/client.rb, line 69</span>
69:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unsubscribe</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">type</span>)
70:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@subscriptions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">agent</span>)
71:         <span class="ruby-identifier">subscription</span> = <span class="ruby-constant">Util</span>.<span class="ruby-identifier">make_subscriptions</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">collective</span>)
72:         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Unsubscribing #{type} target for #{agent}&quot;</span>)
73: 
74:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">unsubscribe</span>(<span class="ruby-identifier">subscription</span>)
75:         <span class="ruby-ivar">@subscriptions</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">agent</span>)
76:       <span class="ruby-keyword kw">end</span>
77:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>