<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: MCollective::Security::Ssl</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">MCollective::Security::Ssl</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/plugins/mcollective/security/ssl_rb.html">
                plugins/mcollective/security/ssl.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="Base.html">
                Base
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Impliments a public/private key based message validation system using <a
href="../SSL.html">SSL</a> public and private keys.
</p>
<p>
The design goal of the plugin is two fold:
</p>
<ul>
<li>give different security credentials to clients and servers to avoid a
compromised server from sending new client requests.

</li>
<li>create a token that uniquely identify the client - based on the filename of
the public key

</li>
</ul>
<p>
To setup you need to create a <a href="../SSL.html">SSL</a> key pair that
is shared by all nodes.
</p>
<pre>
  openssl genrsa -out mcserver-private.pem 1024
  openssl rsa -in mcserver-private.pem -out mcserver-public.pem -outform PEM -pubout
</pre>
<p>
Distribute the private and public file to /etc/mcollective/ssl on all the
nodes. Distribute the public file to /etc/mcollective/ssl everywhere the
client code runs.
</p>
<p>
Now you should create a key pair for every one of your clients, here we
create one for user john - you could also if you are less concerned with
client id create one pair and share it with all clients:
</p>
<pre>
  openssl genrsa -out john-private.pem 1024
  openssl rsa -in john-private.pem -out john-public.pem -outform PEM -pubout
</pre>
<p>
Each user has a unique userid, this is based on the name of the public key.
In this example case the userid would be &#8216;john-public&#8217;.
</p>
<p>
Store these somewhere like:
</p>
<pre>
    /home/john/.mc/john-private.pem
    /home/john/.mc/john-public.pem
</pre>
<p>
Every users public key needs to be distributed to all the nodes, save the
john one in a file called:
</p>
<pre>
  /etc/mcollective/ssl/clients/john-public.pem
</pre>
<p>
If you wish to use registration or auditing that sends connections over MC
to a central host you will need also put the server-public.pem in the
clients directory.
</p>
<p>
You should be aware if you do add the node public key to the clients dir
you will in effect be weakening your overall security. You should consider
doing this only if you also set up an Authorization method that limits the
requests the nodes can make.
</p>
<p>
client.cfg:
</p>
<pre>
  securityprovider = ssl
  plugin.ssl_server_public = /etc/mcollective/ssl/server-public.pem
  plugin.ssl_client_private = /home/john/.mc/john-private.pem
  plugin.ssl_client_public = /home/john/.mc/john-public.pem
</pre>
<p>
If you have many clients per machine and dont want to configure the main
config file with the public/private keys you can set the following
environment variables:
</p>
<pre>
  export MCOLLECTIVE_SSL_PRIVATE=/home/john/.mc/john-private.pem
  export MCOLLECTIVE_SSL_PUBLIC=/home/john/.mc/john-public.pem
</pre>
<p>
server.cfg:
</p>
<pre>
  securityprovider = ssl
  plugin.ssl_server_private = /etc/mcollective/ssl/server-private.pem
  plugin.ssl_server_public = /etc/mcollective/ssl/server-public.pem
  plugin.ssl_client_cert_dir = /etc/mcollective/etc/ssl/clients/
</pre>
<p>
Serialization can be configured to use either Marshal or YAML, data types
in and out of mcollective will be preserved from client to server and
reverse
</p>
<p>
You can configure YAML serialization:
</p>
<pre>
   plugins.ssl_serializer = yaml
</pre>
<p>
else the default is Marshal. Use YAML if you wish to write a client using a
language other than Ruby that doesn&#8216;t support Marshal.
</p>
<p>
Validation is as default and is provided by <a
href="Base.html">MCollective::Security::Base</a>
</p>
<p>
Initial code was contributed by Vladimir Vuksan and modified by R.I.Pienaar
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000042">callerid</a>&nbsp;&nbsp;
      <a href="#M000038">decodemsg</a>&nbsp;&nbsp;
      <a href="#M000039">encodereply</a>&nbsp;&nbsp;
      <a href="#M000040">encoderequest</a>&nbsp;&nbsp;
      <a href="#M000041">validrequest?</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000042" class="method-detail">
        <a name="M000042"></a>

        <div class="method-heading">
          <a href="#M000042" class="method-signature">
          <span class="method-name">callerid</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
sets the caller id to the md5 of the public key
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000042-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000042-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/ssl.rb, line 141</span>
141:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">callerid</span>
142:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
143:                     <span class="ruby-node">&quot;cert=#{File.basename(client_public_key).gsub(/\.pem$/, '')}&quot;</span>
144:                 <span class="ruby-keyword kw">else</span>
145:                     <span class="ruby-comment cmt"># servers need to set callerid as well, not usually needed but</span>
146:                     <span class="ruby-comment cmt"># would be if you're doing registration or auditing or generating</span>
147:                     <span class="ruby-comment cmt"># requests for some or other reason</span>
148:                     <span class="ruby-node">&quot;cert=#{File.basename(server_public_key).gsub(/\.pem$/, '')}&quot;</span>
149:                 <span class="ruby-keyword kw">end</span>
150:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000038" class="method-detail">
        <a name="M000038"></a>

        <div class="method-heading">
          <a href="#M000038" class="method-signature">
          <span class="method-name">decodemsg</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Decodes a message by unserializing all the bits etc, it also validates it
as valid using the psk etc
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000038-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000038-source">
<pre>
    <span class="ruby-comment cmt"># File plugins/mcollective/security/ssl.rb, line 87</span>
87:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decodemsg</span>(<span class="ruby-identifier">msg</span>)
88:                 <span class="ruby-identifier">body</span> = <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">payload</span>)
89: 
90:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">validrequest?</span>(<span class="ruby-identifier">body</span>)
91:                     <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:body</span>] = <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">body</span>[<span class="ruby-identifier">:body</span>])
92:                     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">body</span>
93:                 <span class="ruby-keyword kw">else</span>
94:                     <span class="ruby-keyword kw">nil</span>
95:                 <span class="ruby-keyword kw">end</span>
96:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000039" class="method-detail">
        <a name="M000039"></a>

        <div class="method-heading">
          <a href="#M000039" class="method-signature">
          <span class="method-name">encodereply</span><span class="method-args">(sender, target, msg, requestid, requestcallerid=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Encodes a reply
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000039-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000039-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/ssl.rb, line 99</span>
 99:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encodereply</span>(<span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">requestcallerid</span>=<span class="ruby-keyword kw">nil</span>)
100:                 <span class="ruby-identifier">serialized</span>  = <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">msg</span>)
101:                 <span class="ruby-identifier">digest</span> = <span class="ruby-identifier">makehash</span>(<span class="ruby-identifier">serialized</span>)
102: 
103: 
104:                 <span class="ruby-identifier">req</span> = <span class="ruby-identifier">create_reply</span>(<span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">serialized</span>)
105:                 <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:hash</span>] = <span class="ruby-identifier">digest</span>
106: 
107:                 <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">req</span>)
108:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000040" class="method-detail">
        <a name="M000040"></a>

        <div class="method-heading">
          <a href="#M000040" class="method-signature">
          <span class="method-name">encoderequest</span><span class="method-args">(sender, target, msg, requestid, filter={}, target_agent=nil, target_collective=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Encodes a request msg
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000040-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000040-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/ssl.rb, line 111</span>
111:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encoderequest</span>(<span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">filter</span>={}, <span class="ruby-identifier">target_agent</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">target_collective</span>=<span class="ruby-keyword kw">nil</span>)
112:                 <span class="ruby-identifier">serialized</span> = <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">msg</span>)
113:                 <span class="ruby-identifier">digest</span> = <span class="ruby-identifier">makehash</span>(<span class="ruby-identifier">serialized</span>)
114: 
115:                 <span class="ruby-identifier">req</span> = <span class="ruby-identifier">create_request</span>(<span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">filter</span>, <span class="ruby-identifier">serialized</span>, <span class="ruby-ivar">@initiated_by</span>, <span class="ruby-identifier">target_agent</span>, <span class="ruby-identifier">target_collective</span>)
116:                 <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:hash</span>] = <span class="ruby-identifier">digest</span>
117: 
118:                 <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">req</span>)
119:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000041" class="method-detail">
        <a name="M000041"></a>

        <div class="method-heading">
          <a href="#M000041" class="method-signature">
          <span class="method-name">validrequest?</span><span class="method-args">(req)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks the <a href="../SSL.html">SSL</a> signature in the request body
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000041-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000041-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/ssl.rb, line 122</span>
122:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">validrequest?</span>(<span class="ruby-identifier">req</span>)
123:                 <span class="ruby-identifier">message</span> = <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:body</span>]
124:                 <span class="ruby-identifier">signature</span> = <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:hash</span>]
125: 
126:                 <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Validating request from #{req[:callerid]}&quot;</span>)
127: 
128:                 <span class="ruby-identifier">public_key</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">public_key_file</span>(<span class="ruby-identifier">req</span>[<span class="ruby-identifier">:callerid</span>]))
129: 
130:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verify</span>(<span class="ruby-identifier">public_key</span>, <span class="ruby-identifier">signature</span>, <span class="ruby-identifier">message</span>.<span class="ruby-identifier">to_s</span>)
131:                     <span class="ruby-ivar">@stats</span>.<span class="ruby-identifier">validated</span>
132:                     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
133:                 <span class="ruby-keyword kw">else</span>
134:                     <span class="ruby-ivar">@stats</span>.<span class="ruby-identifier">unvalidated</span>
135:                     <span class="ruby-identifier">raise</span>(<span class="ruby-constant">SecurityValidationFailed</span>, <span class="ruby-value str">&quot;Received an invalid signature in message&quot;</span>)
136:                 <span class="ruby-keyword kw">end</span>
137:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>