<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: MCollective::Security::Aes_security</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">MCollective::Security::Aes_security</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/plugins/mcollective/security/aes_security_rb.html">
                plugins/mcollective/security/aes_security.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="Base.html">
                Base
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Impliments a security system that encrypts payloads using AES and secures
the AES encrypted data using RSA public/private key encryption.
</p>
<p>
The design goals of this plugin are:
</p>
<ul>
<li>Each actor - clients and servers - can have their own set of public and
private keys

</li>
<li>All actors are uniquely and cryptographically identified

</li>
<li>Requests are encrypted using the clients private key and anyone that has
the public key can see the request. Thus an atacker may see the requests
given access to network or machine due to the broadcast nature of
mcollective

</li>
<li>Replies are encrypted using the calling clients public key. Thus no-one but
the caller can view the contents of replies.

</li>
<li>Servers can all have their own RSA keys, or share one, or reuse keys
created by other PKI using software like Puppet

</li>
<li>Requests from servers - like registration data - can be secured even to
external eaves droppers depending on the level of configuration you are
prepared to do

</li>
<li>Given a network where you can ensure third parties are not able to access
the middleware public key distribution can happen automatically

</li>
</ul>
<p>
Configuration Options:
</p>
<h6>================</h6>
<p>
Common Options:
</p>
<pre>
   # Enable this plugin
   securityprovider = aes_security

   # Use YAML as serializer
   plugin.aes.serializer = yaml

   # Send our public key with every request so servers can learn it
   plugin.aes.send_pubkey = 1
</pre>
<p>
Clients:
</p>
<pre>
   # The clients public and private keys
   plugin.aes.client_private = /home/user/.mcollective.d/user-private.pem
   plugin.aes.client_public = /home/user/.mcollective.d/user.pem
</pre>
<p>
Servers:
</p>
<pre>
   # Where to cache client keys or find manually distributed ones
   plugin.aes.client_cert_dir = /etc/mcollective/ssl/clients

   # Cache public keys promiscuously from the network
   plugin.aes.learn_pubkeys = 1

   # The servers public and private keys
   plugin.aes.server_private = /etc/mcollective/ssl/server-private.pem
   plugin.aes.server_public = /etc/mcollective/ssl/server-public.pem
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000048">callerid</a>&nbsp;&nbsp;
      <a href="#M000057">certname_from_callerid</a>&nbsp;&nbsp;
      <a href="#M000056">client_cert_dir</a>&nbsp;&nbsp;
      <a href="#M000052">client_private_key</a>&nbsp;&nbsp;
      <a href="#M000053">client_public_key</a>&nbsp;&nbsp;
      <a href="#M000043">decodemsg</a>&nbsp;&nbsp;
      <a href="#M000050">decrypt</a>&nbsp;&nbsp;
      <a href="#M000047">deserialize</a>&nbsp;&nbsp;
      <a href="#M000044">encodereply</a>&nbsp;&nbsp;
      <a href="#M000045">encoderequest</a>&nbsp;&nbsp;
      <a href="#M000049">encrypt</a>&nbsp;&nbsp;
      <a href="#M000051">public_key_path_for_client</a>&nbsp;&nbsp;
      <a href="#M000046">serialize</a>&nbsp;&nbsp;
      <a href="#M000055">server_private_key</a>&nbsp;&nbsp;
      <a href="#M000054">server_public_key</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000048" class="method-detail">
        <a name="M000048"></a>

        <div class="method-heading">
          <a href="#M000048" class="method-signature">
          <span class="method-name">callerid</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
sets the caller id to the md5 of the public key
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000048-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000048-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 151</span>
151:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">callerid</span>
152:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
153:                     <span class="ruby-keyword kw">return</span> <span class="ruby-node">&quot;cert=#{File.basename(client_public_key).gsub(/\.pem$/, '')}&quot;</span>
154:                 <span class="ruby-keyword kw">else</span>
155:                     <span class="ruby-comment cmt"># servers need to set callerid as well, not usually needed but</span>
156:                     <span class="ruby-comment cmt"># would be if you're doing registration or auditing or generating</span>
157:                     <span class="ruby-comment cmt"># requests for some or other reason</span>
158:                     <span class="ruby-keyword kw">return</span> <span class="ruby-node">&quot;cert=#{File.basename(server_public_key).gsub(/\.pem$/, '')}&quot;</span>
159:                 <span class="ruby-keyword kw">end</span>
160:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">certname_from_callerid</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Takes our cert=foo callerids and return the foo bit else nil
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 249</span>
249:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">certname_from_callerid</span>(<span class="ruby-identifier">id</span>)
250:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^cert=(.+)/</span>
251:                     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">$1</span>
252:                 <span class="ruby-keyword kw">else</span>
253:                     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
254:                 <span class="ruby-keyword kw">end</span>
255:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000056" class="method-detail">
        <a name="M000056"></a>

        <div class="method-heading">
          <a href="#M000056" class="method-signature">
          <span class="method-name">client_cert_dir</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Figures out where to get client public certs from the plugin.aes.<a
href="Aes_security.html#M000056">client_cert_dir</a> config option
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000056-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000056-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 243</span>
243:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">client_cert_dir</span>
244:                 <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No plugin.aes.client_cert_dir configuration option specified&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.client_cert_dir&quot;</span>)
245:                 <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.client_cert_dir&quot;</span>]
246:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000052" class="method-detail">
        <a name="M000052"></a>

        <div class="method-heading">
          <a href="#M000052" class="method-signature">
          <span class="method-name">client_private_key</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Figures out the client private key either from MCOLLECTIVE_AES_PRIVATE or
the plugin.aes.client_private config option
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000052-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000052-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 212</span>
212:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">client_private_key</span>
213:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">ENV</span>[<span class="ruby-value str">&quot;MCOLLECTIVE_AES_PRIVATE&quot;</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;MCOLLECTIVE_AES_PRIVATE&quot;</span>)
214: 
215:                 <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No plugin.aes.client_private configuration option specified&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.client_private&quot;</span>)
216: 
217:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.client_private&quot;</span>]
218:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000053" class="method-detail">
        <a name="M000053"></a>

        <div class="method-heading">
          <a href="#M000053" class="method-signature">
          <span class="method-name">client_public_key</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Figures out the client public key either from MCOLLECTIVE_AES_PUBLIC or the
plugin.aes.client_public config option
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000053-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000053-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 222</span>
222:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">client_public_key</span>
223:                 <span class="ruby-keyword kw">return</span> <span class="ruby-constant">ENV</span>[<span class="ruby-value str">&quot;MCOLLECTIVE_AES_PUBLIC&quot;</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;MCOLLECTIVE_AES_PUBLIC&quot;</span>)
224: 
225:                 <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No plugin.aes.client_public configuration option specified&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.client_public&quot;</span>)
226: 
227:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.client_public&quot;</span>]
228:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000043" class="method-detail">
        <a name="M000043"></a>

        <div class="method-heading">
          <a href="#M000043" class="method-signature">
          <span class="method-name">decodemsg</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000043-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000043-source">
<pre>
    <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 56</span>
56:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decodemsg</span>(<span class="ruby-identifier">msg</span>)
57:                 <span class="ruby-identifier">body</span> = <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">payload</span>)
58: 
59:                 <span class="ruby-comment cmt"># if we get a message that has a pubkey attached and we're set to learn</span>
60:                 <span class="ruby-comment cmt"># then add it to the client_cert_dir this should only happen on servers</span>
61:                 <span class="ruby-comment cmt"># since clients will get replies using their own pubkeys</span>
62:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.learn_pubkeys&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.learn_pubkeys&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;1&quot;</span>
63:                     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">:sslpubkey</span>)
64:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client_cert_dir</span>
65:                             <span class="ruby-identifier">certname</span> = <span class="ruby-identifier">certname_from_callerid</span>(<span class="ruby-identifier">body</span>[<span class="ruby-identifier">:callerid</span>])
66:                             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">certname</span>
67:                                 <span class="ruby-identifier">certfile</span> = <span class="ruby-node">&quot;#{client_cert_dir}/#{certname}.pem&quot;</span>
68:                                 <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">certfile</span>)
69:                                     <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Caching client cert in #{certfile}&quot;</span>)
70:                                     <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">certfile</span>, <span class="ruby-value str">&quot;w&quot;</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">print</span> <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:sslpubkey</span>]}
71:                                 <span class="ruby-keyword kw">end</span>
72:                             <span class="ruby-keyword kw">end</span>
73:                         <span class="ruby-keyword kw">end</span>
74:                     <span class="ruby-keyword kw">end</span>
75:                 <span class="ruby-keyword kw">end</span>
76: 
77:                 <span class="ruby-identifier">cryptdata</span> = {<span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:sslkey</span>], <span class="ruby-identifier">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:body</span>]}
78: 
79:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
80:                     <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:body</span>] = <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">decrypt</span>(<span class="ruby-identifier">cryptdata</span>, <span class="ruby-keyword kw">nil</span>))
81:                 <span class="ruby-keyword kw">else</span>
82:                     <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:body</span>] = <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">decrypt</span>(<span class="ruby-identifier">cryptdata</span>, <span class="ruby-identifier">body</span>[<span class="ruby-identifier">:callerid</span>]))
83:                 <span class="ruby-keyword kw">end</span>
84: 
85:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">body</span>
86:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">PKey</span><span class="ruby-operator">::</span><span class="ruby-constant">RSAError</span>
87:                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">MsgDoesNotMatchRequestID</span>, <span class="ruby-value str">&quot;Could not decrypt message using our key, possibly directed at another client&quot;</span>
88: 
89:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
90:                 <span class="ruby-constant">Log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Could not decrypt message from client: #{e.class}: #{e}&quot;</span>)
91:                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">SecurityValidationFailed</span>, <span class="ruby-value str">&quot;Could not decrypt message&quot;</span>
92:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000050" class="method-detail">
        <a name="M000050"></a>

        <div class="method-heading">
          <a href="#M000050" class="method-signature">
          <span class="method-name">decrypt</span><span class="method-args">(string, certid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000050-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000050-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 185</span>
185:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decrypt</span>(<span class="ruby-identifier">string</span>, <span class="ruby-identifier">certid</span>)
186:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
187:                     <span class="ruby-ivar">@ssl</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">client_public_key</span>, <span class="ruby-identifier">client_private_key</span>)
188: 
189:                     <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Decrypting message using private key&quot;</span>)
190:                     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@ssl</span>.<span class="ruby-identifier">decrypt_with_private</span>(<span class="ruby-identifier">string</span>)
191:                 <span class="ruby-keyword kw">else</span>
192:                     <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Decrypting message using public key for #{certid}&quot;</span>)
193: 
194:                     <span class="ruby-identifier">ssl</span> = <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">public_key_path_for_client</span>(<span class="ruby-identifier">certid</span>))
195:                     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ssl</span>.<span class="ruby-identifier">decrypt_with_public</span>(<span class="ruby-identifier">string</span>)
196:                 <span class="ruby-keyword kw">end</span>
197:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000047" class="method-detail">
        <a name="M000047"></a>

        <div class="method-heading">
          <a href="#M000047" class="method-signature">
          <span class="method-name">deserialize</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
De-Serializes a message using the configured encoder
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000047-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000047-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 137</span>
137:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">deserialize</span>(<span class="ruby-identifier">msg</span>)
138:                 <span class="ruby-identifier">serializer</span> = <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.serializer&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;marshal&quot;</span>
139: 
140:                 <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;De-Serializing using #{serializer}&quot;</span>)
141: 
142:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">serializer</span>
143:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;yaml&quot;</span>
144:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">msg</span>)
145:                     <span class="ruby-keyword kw">else</span>
146:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">msg</span>)
147:                 <span class="ruby-keyword kw">end</span>
148:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000044" class="method-detail">
        <a name="M000044"></a>

        <div class="method-heading">
          <a href="#M000044" class="method-signature">
          <span class="method-name">encodereply</span><span class="method-args">(sender, target, msg, requestid, requestcallerid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Encodes a reply
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000044-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000044-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 95</span>
 95:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encodereply</span>(<span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">requestcallerid</span>)
 96:                 <span class="ruby-identifier">crypted</span> = <span class="ruby-identifier">encrypt</span>(<span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">msg</span>), <span class="ruby-identifier">requestcallerid</span>)
 97: 
 98:                 <span class="ruby-identifier">req</span> = <span class="ruby-identifier">create_reply</span>(<span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">crypted</span>[<span class="ruby-identifier">:data</span>])
 99:                 <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:sslkey</span>] = <span class="ruby-identifier">crypted</span>[<span class="ruby-identifier">:key</span>]
100: 
101:                 <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">req</span>)
102:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000045" class="method-detail">
        <a name="M000045"></a>

        <div class="method-heading">
          <a href="#M000045" class="method-signature">
          <span class="method-name">encoderequest</span><span class="method-args">(sender, target, msg, requestid, filter={}, target_agent=nil, target_collective=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Encodes a request msg
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000045-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000045-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 105</span>
105:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encoderequest</span>(<span class="ruby-identifier">sender</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">filter</span>={}, <span class="ruby-identifier">target_agent</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">target_collective</span>=<span class="ruby-keyword kw">nil</span>)
106:                 <span class="ruby-identifier">crypted</span> = <span class="ruby-identifier">encrypt</span>(<span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">msg</span>), <span class="ruby-identifier">callerid</span>)
107: 
108:                 <span class="ruby-identifier">req</span> = <span class="ruby-identifier">create_request</span>(<span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">filter</span>, <span class="ruby-identifier">crypted</span>[<span class="ruby-identifier">:data</span>], <span class="ruby-ivar">@initiated_by</span>, <span class="ruby-identifier">target_agent</span>, <span class="ruby-identifier">target_collective</span>)
109:                 <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:sslkey</span>] = <span class="ruby-identifier">crypted</span>[<span class="ruby-identifier">:key</span>]
110: 
111:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.send_pubkey&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.send_pubkey&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;1&quot;</span>
112:                     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
113:                         <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:sslpubkey</span>] = <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">client_public_key</span>)
114:                     <span class="ruby-keyword kw">else</span>
115:                         <span class="ruby-identifier">req</span>[<span class="ruby-identifier">:sslpubkey</span>] = <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">server_public_key</span>)
116:                     <span class="ruby-keyword kw">end</span>
117:                 <span class="ruby-keyword kw">end</span>
118: 
119:                 <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">req</span>)
120:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000049" class="method-detail">
        <a name="M000049"></a>

        <div class="method-heading">
          <a href="#M000049" class="method-signature">
          <span class="method-name">encrypt</span><span class="method-args">(string, certid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000049-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000049-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 162</span>
162:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encrypt</span>(<span class="ruby-identifier">string</span>, <span class="ruby-identifier">certid</span>)
163:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@initiated_by</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:client</span>
164:                     <span class="ruby-ivar">@ssl</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">client_public_key</span>, <span class="ruby-identifier">client_private_key</span>)
165: 
166:                     <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Encrypting message using private key&quot;</span>)
167:                     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@ssl</span>.<span class="ruby-identifier">encrypt_with_private</span>(<span class="ruby-identifier">string</span>)
168:                 <span class="ruby-keyword kw">else</span>
169:                     <span class="ruby-comment cmt"># when the server is initating requests like for registration</span>
170:                     <span class="ruby-comment cmt"># then the certid will be our callerid</span>
171:                     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">certid</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">callerid</span>
172:                         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Encrypting message using private key #{server_private_key}&quot;</span>)
173: 
174:                         <span class="ruby-identifier">ssl</span> = <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server_public_key</span>, <span class="ruby-identifier">server_private_key</span>)
175:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ssl</span>.<span class="ruby-identifier">encrypt_with_private</span>(<span class="ruby-identifier">string</span>)
176:                     <span class="ruby-keyword kw">else</span>
177:                         <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Encrypting message using public key for #{certid}&quot;</span>)
178: 
179:                         <span class="ruby-identifier">ssl</span> = <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">public_key_path_for_client</span>(<span class="ruby-identifier">certid</span>))
180:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ssl</span>.<span class="ruby-identifier">encrypt_with_public</span>(<span class="ruby-identifier">string</span>)
181:                     <span class="ruby-keyword kw">end</span>
182:                 <span class="ruby-keyword kw">end</span>
183:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000051" class="method-detail">
        <a name="M000051"></a>

        <div class="method-heading">
          <a href="#M000051" class="method-signature">
          <span class="method-name">public_key_path_for_client</span><span class="method-args">(clientid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
On servers this will look in the aes.client_cert_dir for public keys
matching the clientid, clientid is expected to be in the format set by <a
href="Aes_security.html#M000048">callerid</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000051-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000051-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 202</span>
202:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">public_key_path_for_client</span>(<span class="ruby-identifier">clientid</span>)
203:                 <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown callerid format in '#{clientid}'&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">clientid</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp re">/^cert=(.+)$/</span>)
204: 
205:                 <span class="ruby-identifier">clientid</span> = <span class="ruby-identifier">$1</span>
206: 
207:                 <span class="ruby-identifier">client_cert_dir</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot;/#{clientid}.pem&quot;</span>
208:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000046" class="method-detail">
        <a name="M000046"></a>

        <div class="method-heading">
          <a href="#M000046" class="method-signature">
          <span class="method-name">serialize</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Serializes a message using the configured encoder
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000046-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000046-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 123</span>
123:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">serialize</span>(<span class="ruby-identifier">msg</span>)
124:                 <span class="ruby-identifier">serializer</span> = <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.serializer&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;marshal&quot;</span>
125: 
126:                 <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Serializing using #{serializer}&quot;</span>)
127: 
128:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">serializer</span>
129:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;yaml&quot;</span>
130:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">YAML</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">msg</span>)
131:                     <span class="ruby-keyword kw">else</span>
132:                         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">msg</span>)
133:                 <span class="ruby-keyword kw">end</span>
134:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000055" class="method-detail">
        <a name="M000055"></a>

        <div class="method-heading">
          <a href="#M000055" class="method-signature">
          <span class="method-name">server_private_key</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Figures out the server private key from the plugin.aes.server_private
config option
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000055-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000055-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 237</span>
237:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">server_private_key</span>
238:                 <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No plugin.aes.server_private configuration option specified&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.server_private&quot;</span>)
239:                 <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.server_private&quot;</span>]
240:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000054" class="method-detail">
        <a name="M000054"></a>

        <div class="method-heading">
          <a href="#M000054" class="method-signature">
          <span class="method-name">server_public_key</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Figures out the server public key from the plugin.aes.server_public config
option
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000054-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000054-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/mcollective/security/aes_security.rb, line 231</span>
231:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">server_public_key</span>
232:                 <span class="ruby-identifier">raise</span>(<span class="ruby-value str">&quot;No aes.server_public configuration option specified&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">&quot;aes.server_public&quot;</span>)
233:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@config</span>.<span class="ruby-identifier">pluginconf</span>[<span class="ruby-value str">&quot;aes.server_public&quot;</span>]
234:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>