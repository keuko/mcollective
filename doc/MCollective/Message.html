<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class MCollective::Message - mcollective version 2.12.1</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="../Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-base64-3F">#base64?</a>
    
    <li ><a href="#method-i-base64_decode-21">#base64_decode!</a>
    
    <li ><a href="#method-i-base64_encode-21">#base64_encode!</a>
    
    <li ><a href="#method-i-create_reqid">#create_reqid</a>
    
    <li ><a href="#method-i-decode-21">#decode!</a>
    
    <li ><a href="#method-i-description">#description</a>
    
    <li ><a href="#method-i-encode-21">#encode!</a>
    
    <li ><a href="#method-i-expected_msgid-3D">#expected_msgid=</a>
    
    <li ><a href="#method-i-publish">#publish</a>
    
    <li ><a href="#method-i-reply_to-3D">#reply_to=</a>
    
    <li ><a href="#method-i-type-3D">#type=</a>
    
    <li ><a href="#method-i-validate">#validate</a>
    
    <li ><a href="#method-i-validate_compound_filter">#validate_compound_filter</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-MCollective::Message">
  <h1 id="class-MCollective::Message" class="class">
    class MCollective::Message
  </h1>

  <section class="description">
    
<p>container for a message, its headers, agent, collective and other meta data</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="VALIDTYPES">VALIDTYPES
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-agent" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">agent</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-collective" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">collective</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-discovered_hosts" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">discovered_hosts</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-expected_msgid" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">expected_msgid</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-filter" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">filter</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-headers" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">headers</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-message" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">message</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-msgtime" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">msgtime</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-options" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">options</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-payload" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">payload</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-reply_to" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">reply_to</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-request" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">request</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-requestid" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">requestid</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-ttl" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">ttl</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-type" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">type</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-validated" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">validated</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(payload, message, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>payload                  - the message body without headers etc, just the
text message                  - the original message received from the
middleware <a href=":base64">options</a>         - if the body base64
encoded? <a href=":agent">options</a>          - the agent the message is
for/from <a href=":collective">options</a>     - the collective its
for/from <a href=":headers">options</a>        - the message headers <a
href=":type">options</a>           - an indicator about the type of
message, :message, :request, :direct_request or :reply <a
href=":request">options</a>        - if this is a reply this should old the
message we are replying to <a href=":filter">options</a>         - for
requests, the filter to encode into the message <a
href=":options">options</a>        - the normal client options hash <a
href=":ttl">options</a>            - the maximum amount of seconds this
message can be valid for <a href=":expected_msgid">options</a> - in the
case of replies this is the msgid it is expecting in the replies <a
href=":requestid">options</a>      - specific request id to use else one
will be generated</p>
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 23</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">payload</span>, <span class="ruby-identifier">message</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">options</span> = {<span class="ruby-value">:base64</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>,
             <span class="ruby-value">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
             <span class="ruby-value">:headers</span> =<span class="ruby-operator">&gt;</span> {},
             <span class="ruby-value">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:message</span>,
             <span class="ruby-value">:request</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
             <span class="ruby-value">:filter</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Util</span>.<span class="ruby-identifier">empty_filter</span>,
             <span class="ruby-value">:options</span> =<span class="ruby-operator">&gt;</span> {},
             <span class="ruby-value">:ttl</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">60</span>,
             <span class="ruby-value">:expected_msgid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
             <span class="ruby-value">:requestid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>,
             <span class="ruby-value">:collective</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">nil</span>}.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>)

  <span class="ruby-ivar">@payload</span> = <span class="ruby-identifier">payload</span>
  <span class="ruby-ivar">@message</span> = <span class="ruby-identifier">message</span>
  <span class="ruby-ivar">@requestid</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:requestid</span>]
  <span class="ruby-ivar">@discovered_hosts</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@reply_to</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-ivar">@type</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:type</span>]
  <span class="ruby-ivar">@headers</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:headers</span>]
  <span class="ruby-ivar">@base64</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:base64</span>]
  <span class="ruby-ivar">@filter</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:filter</span>]
  <span class="ruby-ivar">@expected_msgid</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:expected_msgid</span>]
  <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:options</span>]

  <span class="ruby-ivar">@ttl</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-value">:ttl</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Config</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">ttl</span>
  <span class="ruby-ivar">@msgtime</span> = <span class="ruby-value">0</span>

  <span class="ruby-ivar">@validated</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:request</span>]
    <span class="ruby-ivar">@request</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:request</span>]
    <span class="ruby-ivar">@agent</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">agent</span>
    <span class="ruby-ivar">@collective</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">collective</span>
    <span class="ruby-ivar">@type</span> = <span class="ruby-value">:reply</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@agent</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:agent</span>]
    <span class="ruby-ivar">@collective</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:collective</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">base64_decode!</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-base64-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">base64?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="base64-3F-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 129</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">base64?</span>
  <span class="ruby-ivar">@base64</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-base64_decode-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">base64_decode!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="base64_decode-21-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 115</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">base64_decode!</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@base64</span>

  <span class="ruby-ivar">@payload</span> = <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">base64_decode</span>(<span class="ruby-ivar">@payload</span>)
  <span class="ruby-ivar">@base64</span> = <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-base64_encode-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">base64_encode!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="base64_encode-21-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">base64_encode!</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@base64</span>

  <span class="ruby-ivar">@payload</span> = <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">base64_encode</span>(<span class="ruby-ivar">@payload</span>)
  <span class="ruby-ivar">@base64</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-create_reqid" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_reqid</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="create_reqid-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 241</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create_reqid</span>
  <span class="ruby-comment"># we gsub out the -s so that the format of the id does not</span>
  <span class="ruby-comment"># change from previous versions, these should just be more</span>
  <span class="ruby-comment"># unique than previous ones</span>
  <span class="ruby-constant">SSL</span>.<span class="ruby-identifier">uuid</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;-&quot;</span>, <span class="ruby-string">&quot;&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-decode-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">decode!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="decode-21-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 183</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">decode!</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Cannot decode message type #{type}&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-value">:request</span>, <span class="ruby-value">:reply</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-ivar">@payload</span> = <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">decodemsg</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:request</span>
      <span class="ruby-comment"># If we're a server receiving a request, reraise</span>
      <span class="ruby-identifier">raise</span>(<span class="ruby-identifier">e</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># We're in the client, log and carry on as best we can</span>

      <span class="ruby-comment"># Note: mc_sender is unverified.  The verified identity is in the</span>
      <span class="ruby-comment"># payload we just failed to decode</span>
      <span class="ruby-constant">Log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Failed to decode a message from '#{headers[&quot;mc_sender&quot;]}': #{e}&quot;</span>)
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:request</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">'callerid in request is not valid, surpressing reply to potentially forged request'</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">valid_callerid?</span>(<span class="ruby-identifier">payload</span>[<span class="ruby-value">:callerid</span>])
  <span class="ruby-keyword">end</span>

  [<span class="ruby-value">:collective</span>, <span class="ruby-value">:agent</span>, <span class="ruby-value">:filter</span>, <span class="ruby-value">:requestid</span>, <span class="ruby-value">:ttl</span>, <span class="ruby-value">:msgtime</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prop</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-node">&quot;@#{prop}&quot;</span>, <span class="ruby-identifier">payload</span>[<span class="ruby-identifier">prop</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">prop</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-description" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">description</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="description-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 133</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">description</span>
  <span class="ruby-identifier">cid</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">cid</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">payload</span>[<span class="ruby-value">:callerid</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;@&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value">:callerid</span>)
  <span class="ruby-identifier">cid</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">payload</span>[<span class="ruby-value">:senderid</span>]

  <span class="ruby-node">&quot;#{requestid} for agent '#{agent}' in collective '#{collective}' from #{cid}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-encode-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">encode!</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="encode-21-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 141</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">encode!</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:reply</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Cannot encode a reply message if no request has been associated with it&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">request</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">'callerid in original request is not valid, surpressing reply to potentially forged request'</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">valid_callerid?</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-value">:callerid</span>])

      <span class="ruby-ivar">@requestid</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-value">:requestid</span>]
      <span class="ruby-ivar">@payload</span> = <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">encodereply</span>(<span class="ruby-identifier">agent</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">request</span>.<span class="ruby-identifier">payload</span>[<span class="ruby-value">:callerid</span>])
    <span class="ruby-keyword">when</span> <span class="ruby-value">:request</span>, <span class="ruby-value">:direct_request</span>
      <span class="ruby-identifier">validate_compound_filter</span>(<span class="ruby-ivar">@filter</span>[<span class="ruby-string">&quot;compound&quot;</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@filter</span>[<span class="ruby-string">&quot;compound&quot;</span>].<span class="ruby-identifier">empty?</span>

      <span class="ruby-ivar">@requestid</span> = <span class="ruby-identifier">create_reqid</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@requestid</span>
      <span class="ruby-ivar">@payload</span> = <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">encoderequest</span>(<span class="ruby-constant">Config</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">identity</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">requestid</span>, <span class="ruby-identifier">filter</span>, <span class="ruby-identifier">agent</span>, <span class="ruby-identifier">collective</span>, <span class="ruby-identifier">ttl</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Cannot encode #{type} messages&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-expected_msgid-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">expected_msgid=</span><span
            class="method-args">(msgid)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>in the case of reply messages we are expecting replies to a previously
created message.  This stores a hint to that previously sent message id and
can be used by other classes like the security plugins as a means of
optimizing their behavior like by ignoring messages not directed at us.</p>
          
          

          
          <div class="method-source-code" id="expected_msgid-3D-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 110</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">expected_msgid=</span>(<span class="ruby-identifier">msgid</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Can only store the expected msgid for reply messages&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:reply</span>
  <span class="ruby-ivar">@expected_msgid</span> = <span class="ruby-identifier">msgid</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-publish" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">publish</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>publish a reply message by creating a target name and sending it</p>
          
          

          
          <div class="method-source-code" id="publish-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 228</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">publish</span>
  <span class="ruby-comment"># If we've been specificaly told about hosts that were discovered</span>
  <span class="ruby-comment"># use that information to do P2P calls if appropriate else just</span>
  <span class="ruby-comment"># send it as is.</span>
  <span class="ruby-identifier">config</span> = <span class="ruby-constant">Config</span>.<span class="ruby-identifier">instance</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@discovered_hosts</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">direct_addressing</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@discovered_hosts</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">direct_addressing_threshold</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">type</span> = <span class="ruby-value">:direct_request</span>
    <span class="ruby-constant">Log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Handling #{requestid} as a direct request&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">'connector_plugin'</span>].<span class="ruby-identifier">publish</span>(<span class="ruby-keyword">self</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reply_to-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reply_to=</span><span
            class="method-args">(target)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Sets a custom reply-to target for requests.  The connector plugin should
inspect this when constructing requests and set this header ensuring
replies will go to the custom target otherwise the connector should just do
what it usually does</p>
          
          

          
          <div class="method-source-code" id="reply_to-3D-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 99</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reply_to=</span>(<span class="ruby-identifier">target</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Custom reply targets can only be set on requests&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-value">:request</span>, <span class="ruby-value">:direct_request</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@type</span>)

  <span class="ruby-ivar">@reply_to</span> = <span class="ruby-identifier">target</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-type-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">type=</span><span
            class="method-args">(type)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Sets the message type to one of the known types.  In the case of
:direct_request the list of hosts to communicate with should have been set
with <a
href="Message.html#attribute-i-discovered_hosts">discovered_hosts</a> else
an exception will be raised.  This is for extra security, we never
accidentally want to send a direct request without a list of hosts or
something weird like that as it might result in a filterless broadcast
being sent.</p>

<p>Additionally you simply cannot set :direct_request if direct_addressing was
not enabled this is to force a workflow that doesnt not yield in a mistake
when someone might assume direct_addressing is enabled when its not.</p>
          
          

          
          <div class="method-source-code" id="type-3D-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 76</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">type=</span>(<span class="ruby-identifier">type</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown message type #{type}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">VALIDTYPES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:direct_request</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Direct requests is not enabled using the direct_addressing config option&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Config</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">direct_addressing</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@discovered_hosts</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@discovered_hosts</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Can only set type to :direct_request if discovered_hosts have been set&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># clear out the filter, custom discovery sources might interpret the filters</span>
    <span class="ruby-comment"># different than the remote mcollectived and in directed mode really the only</span>
    <span class="ruby-comment"># filter that matters is the agent filter</span>
    <span class="ruby-ivar">@filter</span> = <span class="ruby-constant">Util</span>.<span class="ruby-identifier">empty_filter</span>
    <span class="ruby-ivar">@filter</span>[<span class="ruby-string">&quot;agent&quot;</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@agent</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@type</span> = <span class="ruby-identifier">type</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-validate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Perform validation against the message by checking filters and ttl</p>
          
          

          
          <div class="method-source-code" id="validate-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 212</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">validate</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Can only validate request messages&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:request</span>

  <span class="ruby-identifier">msg_age</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">msgtime</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">msg_age</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ttl</span>
    <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;global_stats&quot;</span>].<span class="ruby-identifier">ttlexpired</span>
    <span class="ruby-identifier">raise</span>(<span class="ruby-constant">MsgTTLExpired</span>, <span class="ruby-node">&quot;Message #{description} created at #{msgtime} is #{msg_age} seconds old, TTL is #{ttl}. Rejecting message.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">raise</span>(<span class="ruby-constant">NotTargettedAtUs</span>, <span class="ruby-node">&quot;Message #{description} does not pass filters. Ignoring message.&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">PluginManager</span>[<span class="ruby-string">&quot;security_plugin&quot;</span>].<span class="ruby-identifier">validate_filter?</span>(<span class="ruby-identifier">payload</span>[<span class="ruby-value">:filter</span>])

  <span class="ruby-ivar">@validated</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-validate_compound_filter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_compound_filter</span><span
            class="method-args">(compound_filter)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="validate_compound_filter-source">
            <pre><span class="ruby-comment"># File lib/mcollective/message.rb, line 159</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">validate_compound_filter</span>(<span class="ruby-identifier">compound_filter</span>)
  <span class="ruby-identifier">compound_filter</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">statement</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>]
        <span class="ruby-identifier">functionname</span> = <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>][<span class="ruby-string">&quot;name&quot;</span>]
        <span class="ruby-identifier">pluginname</span> = <span class="ruby-constant">Data</span>.<span class="ruby-identifier">pluginname</span>(<span class="ruby-identifier">functionname</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>][<span class="ruby-string">&quot;value&quot;</span>]

        <span class="ruby-identifier">ddl</span> = <span class="ruby-constant">DDL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pluginname</span>, <span class="ruby-value">:data</span>)

        <span class="ruby-comment"># parses numbers and booleans entered as strings into proper</span>
        <span class="ruby-comment"># types of data so that DDL validation will pass</span>
        <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>][<span class="ruby-string">&quot;params&quot;</span>] = <span class="ruby-constant">Data</span>.<span class="ruby-identifier">ddl_transform_input</span>(<span class="ruby-identifier">ddl</span>, <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>][<span class="ruby-string">&quot;params&quot;</span>])

        <span class="ruby-constant">Data</span>.<span class="ruby-identifier">ddl_validate</span>(<span class="ruby-identifier">ddl</span>, <span class="ruby-identifier">statement</span>[<span class="ruby-string">&quot;fstatement&quot;</span>][<span class="ruby-string">&quot;params&quot;</span>])

        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Data</span>.<span class="ruby-identifier">ddl_has_output?</span>(<span class="ruby-identifier">ddl</span>, <span class="ruby-identifier">value</span>)
          <span class="ruby-constant">DDL</span>.<span class="ruby-identifier">validation_fail!</span>(<span class="ruby-value">:PLMC41</span>, <span class="ruby-string">&quot;Data plugin '%{functionname}()' does not return a '%{value}' value&quot;</span>, <span class="ruby-value">:error</span>, {<span class="ruby-value">:functionname</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">functionname</span>, <span class="ruby-value">:value</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span>})
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

